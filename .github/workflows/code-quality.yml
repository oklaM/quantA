# quantA 代码质量检查工作流
# 专门用于代码质量、风格和安全检查，不运行测试

name: Code Quality

on:
  pull_request:
    branches: [ master, main, develop ]
  push:
    branches: [ master, main, develop ]
  workflow_dispatch:  # 允许手动触发

env:
  PYTHON_VERSION: "3.10"

jobs:
  # ========================================
  # Black代码格式检查
  # ========================================
  black-check:
    name: Black Format Check
    runs-on: ubuntu-latest
    timeout-minutes: 5

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'

      - name: Install Black
        run: |
          python -m pip install --upgrade pip
          pip install black

      - name: Run Black check
        run: |
          black --check --diff --color .

      - name: Generate Black diff report
        if: failure()
        run: |
          echo "### Black Format Issues :hammer:" >> $GITHUB_STEP_SUMMARY
          echo '```diff' >> $GITHUB_STEP_SUMMARY
          black --diff . >> $GITHUB_STEP_SUMMARY || true
          echo '```' >> $GITHUB_STEP_SUMMARY

  # ========================================
  # isort导入排序检查
  # ========================================
  isort-check:
    name: isort Import Sort Check
    runs-on: ubuntu-latest
    timeout-minutes: 5

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'

      - name: Install isort
        run: |
          python -m pip install --upgrade pip
          pip install isort

      - name: Run isort check
        run: |
          isort --check-only --diff --profile=black .

      - name: Generate isort diff report
        if: failure()
        run: |
          echo "### isort Import Sort Issues :hammer:" >> $GITHUB_STEP_SUMMARY
          echo '```diff' >> $GITHUB_STEP_SUMMARY
          isort --diff --profile=black . >> $GITHUB_STEP_SUMMARY || true
          echo '```' >> $GITHUB_STEP_SUMMARY

  # ========================================
  # Flake8代码风格检查
  # ========================================
  flake8-check:
    name: Flake8 Lint Check
    runs-on: ubuntu-latest
    timeout-minutes: 5

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'

      - name: Install Flake8
        run: |
          python -m pip install --upgrade pip
          pip install flake8 flake8-docstrings flake8-bugbear

      - name: Create Flake8 config
        run: |
          cat > .flake8 << 'EOF'
          [flake8]
          max-line-length = 127
          extend-ignore = E203, W503
          exclude =
              .git,
              __pycache__,
              .pytest_cache,
              .eggs,
              *.egg,
              build,
              dist,
              venv,
              .venv
          max-complexity = 10
          docstring-convention = google
          EOF

      - name: Run Flake8 (critical errors only)
        run: |
          flake8 . --count --select=E9,F63,F7,F82 --show-source --statistics

      - name: Run Flake8 (full check)
        run: |
          flake8 . --count --exit-zero --max-complexity=10 --max-line-length=127 --statistics

      - name: Generate Flake8 report
        if: failure()
        run: |
          echo "### Flake8 Lint Issues :warning:" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          flake8 . >> $GITHUB_STEP_SUMMARY || true
          echo '```' >> $GITHUB_STEP_SUMMARY

  # ========================================
  # mypy类型检查
  # ========================================
  mypy-check:
    name: mypy Type Check
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'

      - name: Install mypy
        run: |
          python -m pip install --upgrade pip
          pip install mypy types-requests types-pyyaml

      - name: Create mypy config
        run: |
          cat > mypy.ini << 'EOF'
          [mypy]
          python_version = 3.10
          warn_return_any = True
          warn_unused_configs = True
          disallow_untyped_defs = False
          ignore_missing_imports = True

          [mypy-tests.*]
          ignore_errors = True

          [mypy-rust_engine.*]
          ignore_errors = True
          EOF

      - name: Run mypy on core modules
        run: |
          mypy backtest/ \
                rl/ \
                agents/ \
                data/ \
                --ignore-missing-imports \
                --no-strict-optional || true

      - name: Generate mypy report
        if: failure()
        run: |
          echo "### mypy Type Check Issues :rotating_light:" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          mypy backtest/ rl/ agents/ --ignore-missing-imports || true >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY

  # ========================================
  # Bandit安全检查
  # ========================================
  bandit-check:
    name: Bandit Security Check
    runs-on: ubuntu-latest
    timeout-minutes: 5

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'

      - name: Install Bandit
        run: |
          python -m pip install --upgrade pip
          pip install bandit

      - name: Run Bandit security check
        run: |
          bandit -r . \
            -f json \
            -o bandit-report.json \
            -x tests/,setup.py,.github/ \
            -ll || true

      - name: Run Bandit with severity check
        run: |
          # 只报告高严重性问题
          bandit -r . \
            -x tests/,setup.py,.github/,venv/,.venv/ \
            -ii

      - name: Upload Bandit report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: bandit-security-report
          path: bandit-report.json
          retention-days: 30

      - name: Generate Bandit summary
        if: always()
        run: |
          echo "### Bandit Security Scan :shield:" >> $GITHUB_STEP_SUMMARY
          if [ -f bandit-report.json ]; then
            echo '```json' >> $GITHUB_STEP_SUMMARY
            cat bandit-report.json >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
          else
            echo "No security issues found! :white_check_mark:" >> $GITHUB_STEP_SUMMARY
          fi

  # ========================================
  # Safety依赖安全检查
  # ========================================
  safety-check:
    name: Safety Dependency Check
    runs-on: ubuntu-latest
    timeout-minutes: 5

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install Safety
        run: |
          python -m pip install --upgrade pip
          pip install safety

      - name: Run Safety check
        run: |
          safety check --json --output safety-report.json || true

      - name: Generate Safety summary
        if: always()
        run: |
          echo "### Safety Dependency Check :lock:" >> $GITHUB_STEP_SUMMARY
          if [ -f safety-report.json ]; then
            echo '```json' >> $GITHUB_STEP_SUMMARY
            cat safety-report.json >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
          else
            echo "No vulnerable dependencies found! :white_check_mark:" >> $GITHUB_STEP_SUMMARY
          fi

  # ========================================
  # pylint代码质量检查
  # ========================================
  pylint-check:
    name: Pylint Quality Check
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pylint
          pip install -r requirements.txt

      - name: Create Pylint config
        run: |
          cat > pylintrc << 'EOF'
          [MASTER]
          disable=
              C0111,  # missing-docstring
              C0103,  # invalid-name
              R0903,  # too-few-public-methods
              R0913,  # too-many-arguments
              R0914,  # too-many-locals
              W0212,  # protected-access
              C0114,  # missing-module-docstring
              C0115,  # missing-class-docstring
              C0116,  # missing-function-docstring

          [FORMAT]
          max-line-length=127

          [DESIGN]
          max-args=10
          max-locals=15
          max-returns=6
          max-branches=15
          max-statements=60
          EOF

      - name: Run Pylint (errors only)
        run: |
          pylint backtest/ rl/ agents/ --errors-only || true

      - name: Generate Pylint report
        if: always()
        run: |
          echo "### Pylint Quality Check :mag:" >> $GITHUB_STEP_SUMMARY
          echo "Running pylint with error-level checks only" >> $GITHUB_STEP_SUMMARY

  # ========================================
  # 代码复杂度分析
  # ========================================
  complexity-check:
    name: Code Complexity Analysis
    runs-on: ubuntu-latest
    timeout-minutes: 5

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install radon
        run: |
          python -m pip install --upgrade pip
          pip install radon

      - name: Run Cyclomatic Complexity analysis
        run: |
          radon cc backtest/ rl/ agents/ -a -nb --total-average

      - name: Run Maintainability Index analysis
        run: |
          radon mi backtest/ rl/ agents/ -nb

      - name: Generate complexity summary
        if: always()
        run: |
          echo "### Code Complexity Analysis :chart_with_upwards_trend:" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          radon cc backtest/ rl/ agents/ -a --total-average >> $GITHUB_STEP_SUMMARY || true
          echo '```' >> $GITHUB_STEP_SUMMARY

  # ========================================
  # 代码质量汇总报告
  # ========================================
  quality-summary:
    name: Quality Summary
    runs-on: ubuntu-latest
    needs: [black-check, isort-check, flake8-check, mypy-check, bandit-check, safety-check]
    if: always()

    steps:
      - name: Generate summary
        run: |
          echo "## Code Quality Check Summary :clipboard:" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Check | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Black | ${{ needs.black-check.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| isort | ${{ needs.isort-check.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Flake8 | ${{ needs.flake8-check.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| mypy | ${{ needs.mypy-check.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Bandit | ${{ needs.bandit-check.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Safety | ${{ needs.safety-check.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

      - name: Check overall status
        run: |
          if [[ "${{ needs.black-check.result }}" == "failure" ]] || \
             [[ "${{ needs.isort-check.result }}" == "failure" ]] || \
             [[ "${{ needs.flake8-check.result }}" == "failure" ]] || \
             [[ "${{ needs.bandit-check.result }}" == "failure" ]]; then
            echo "❌ Code quality checks failed!"
            exit 1
          else
            echo "✅ All critical code quality checks passed!"
          fi
